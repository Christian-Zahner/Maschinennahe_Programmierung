/************************************
 * Filename		 : UE07A_bitrev.c	*
 * Created on	 : Nov 29, 2018		*
 * Author		 : Christian Zahner	*
 ************************************/

#pragma compact_abi 

#include "UART0.h"
#include "support_common.h"  // include peripheral declarations and more; 
#include "uart_support.h"    // universal asynchronous receiver transmitter,
                             // (d.h. die serielle Schnittstelle)
#include "terminal_wrapper.h"
#include "Intro.h"
#include <stdio.h>

#include "UE07A_Bitrev.h"

char zero[] = "0";
char one[]  = "1";

unsigned long bitrevUp(unsigned long quelle){
	
	
  asm{
	  	  	  	bra			start
	  start:
				/*adda 		#-12, sp			// Platz für Register auf Stack machen
				movem.l 	d1-d3,(sp)*/			// Register sichern

				clr.l		d0		 			// Dazenregister mit 0 initialisieren
				clr.l		d1					
				clr.l		d2
				clr.l		d3					// Beginn am "0ten" Bit mit Bitset
				
				move.l      quelle,d1			// Inhalte Quelle in Datenregister 
			
				move.l		#31, d2				// Anzahl ist wieviele Bits sollen kopiert werden
				
				
				bra 		looptst
				
	looptst:
				btst.l		d2, d1				// Bit an position 1 oder 0
				bgt			bitset
				
				addi.l		#1, d3				// naechste Bit Stelle die gesetzt werden soll
				subi.l  	#1, d2				// naechste Bit Position die geteste wird
				tst.b		d2					// testen 0?
				blt			end
				
				bra 		looptst
	bitset:		
				bset.l		d3, d0				// Bit setzten in Dataregister
				subi.l  	#1, d2				// naechste Bit Position die geteste wird
				addi.l		#1, d3				// naechste Bit Stelle die gesetzt werden soll
				bra			looptst				
				
	end:		
				/*movem.l 	(sp), d1-d3			// Register sichern
				adda 		#12, sp				// Platz für Register auf Stack machen
				rts*/
				
	}
}

void printbit(int zahl){
	
	asm{
					clr.l		d1
					move.l		zahl, d1				// Bitmuster in Speicherschreiben
					move.l		#31, d2
					bra			outptloop				// Springe zur Marke out
					
		outptloop:	
					subi.l  	#1, d2				// wieder an Stelle 31 beginnend
					tst.b		d3
					blt			end
					btst.l		d2, d1
					beq			zero
					bgt			one
		
		zero:		
		  	  	  	pea 		zero 			 	//  Adresse char zero auf Stack 	 
		  	  	  	jsr			TERM_WriteString	
		  	  	  	adda		#4, SP				// Stack bereinigen
		  	  	  	bra 		outptloop
		  	  	  	
		one:		
					pea			one					// Adresse char one auf Stack
		  			jsr			TERM_WriteString	
		  			adda		#4, SP				// Stack bereinigen
		  			bra 		outptloop
		 
		end:		
		 	 	 	//movem.l 	(sp),d1-d4/a1-a2	// Register restaurieren
					//adda 		#24,sp				// Platz für Register auf Stack machen
					
					//jsr			TERM_WriteLn		//neue Zeile
	}
}

void IntroUe07A(){
 	TERM_WriteString("\n########################################################################\r\n");
 	TERM_WriteString("\nUebung7a: Schreiben sie ein Unterprogramm (keine Stackframes, Parameter-\r\n");
 	TERM_WriteString("          uebergabe nicht ueber den Stack sondern ueber Register), das \r\n");
 	TERM_WriteString("          den Befehl BITREV nachbildet.\r\n");
 	TERM_WriteString("\n########################################################################\r\n\n");
}
